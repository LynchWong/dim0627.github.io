<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Cloudfront on Unresolved</title>
    <link>https://yet.unresolved.xyz/tags/cloudfront/</link>
    <description>Recent content in Cloudfront on Unresolved</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>ja-jp</language>
    <lastBuildDate>Wed, 30 Mar 2016 10:46:34 +0900</lastBuildDate>
    <atom:link href="https://yet.unresolved.xyz/tags/cloudfront/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>CloudFrontをL7スイッチにして特定パスをTumblrに飛ばす</title>
      <link>https://yet.unresolved.xyz/blog/2016/03/30/using-the-cloudfront-as-l7-switch/</link>
      <pubDate>Wed, 30 Mar 2016 10:46:34 +0900</pubDate>
      
      <guid>https://yet.unresolved.xyz/blog/2016/03/30/using-the-cloudfront-as-l7-switch/</guid>
      <description>

&lt;p&gt;ELBだとパスによる振り分けが現状できない（と思う）ので、CloudFrontでなんとかしてみよう。
今回はルートパスをS3の静的ファイル、特定パスをTumblrに飛ばすようにしてみる。&lt;/p&gt;

&lt;h2 id=&#34;s3の設定:a5812bfe3dbcf9a23add352ce7e9224f&#34;&gt;S3の設定&lt;/h2&gt;

&lt;p&gt;まずテスト的な静的ファイルをS3に配置する。
このままだとS3に対してHTTPアクセスが出来ないので、静的WebサイトホスティングをOnにしてBucketPolicyを追加する。
&lt;a href=&#34;https://yet.unresolved.xyz/images/2016-03-30/s3-static.png&#34; target=&#34;_blank&#34; rel=&#34;nofollow&#34;&gt;
  &lt;amp-img src=&#34;https://yet.unresolved.xyz/images/2016-03-30/s3-static.png&#34; alt=&#34;s3-static&#34; width=1658 height=746 layout=&#34;responsive&#34;&gt;&lt;/amp-img&gt;
&lt;/a&gt;
&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/dev/HostingWebsiteOnS3Setup.html&#34;&gt;例: 静的ウェブサイトをセットアップする - Amazon Simple Storage Service&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-json&#34;&gt;{
  &amp;quot;Version&amp;quot;: &amp;quot;2012-10-17&amp;quot;,
  &amp;quot;Statement&amp;quot;: [
    {
      &amp;quot;Sid&amp;quot;: &amp;quot;PublicReadForGetBucketObjects&amp;quot;,
      &amp;quot;Effect&amp;quot;: &amp;quot;Allow&amp;quot;,
      &amp;quot;Principal&amp;quot;: &amp;quot;*&amp;quot;,
      &amp;quot;Action&amp;quot;: &amp;quot;s3:GetObject&amp;quot;,
      &amp;quot;Resource&amp;quot;: &amp;quot;arn:aws:s3:::your.bucket.name/*&amp;quot;
    }
  ]
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;これでS3へHTTPアクセスが出来るようになった。
次はこのバケットへCloudFront経由でアクセスできるようにする。&lt;/p&gt;

&lt;h2 id=&#34;cloudfrontの設定:a5812bfe3dbcf9a23add352ce7e9224f&#34;&gt;CloudFrontの設定&lt;/h2&gt;

&lt;p&gt;S3のオリジンとTumblrのオリジンを作って、
&lt;a href=&#34;https://yet.unresolved.xyz/images/2016-03-30/cloudfront-origins.png&#34; target=&#34;_blank&#34; rel=&#34;nofollow&#34;&gt;
  &lt;amp-img src=&#34;https://yet.unresolved.xyz/images/2016-03-30/cloudfront-origins.png&#34; alt=&#34;cloudfront-origins&#34; width=1402 height=244 layout=&#34;responsive&#34;&gt;&lt;/amp-img&gt;
&lt;/a&gt;

ビヘイビアでパスによる振り分けをしてしまえば完了。
&lt;a href=&#34;https://yet.unresolved.xyz/images/2016-03-30/cloudfront-behaviors.png&#34; target=&#34;_blank&#34; rel=&#34;nofollow&#34;&gt;
  &lt;amp-img src=&#34;https://yet.unresolved.xyz/images/2016-03-30/cloudfront-behaviors.png&#34; alt=&#34;cloudfront-behaviors&#34; width=1258 height=246 layout=&#34;responsive&#34;&gt;&lt;/amp-img&gt;
&lt;/a&gt;

CloudFrontってオリジンごとにデフォルトルートオブジェクト指定出来ないのかな。&lt;/p&gt;

&lt;h2 id=&#34;tumblrの設定:a5812bfe3dbcf9a23add352ce7e9224f&#34;&gt;Tumblrの設定&lt;/h2&gt;

&lt;p&gt;このままだとTumblrが持ってるドメイン（****.tumblr.com）がそのまま生きてしまうので、これを何とかする。
そういえば、Tumblrに独自ドメインの設定が見つからない！と思ったら、僕がメールでのverifyを放置してたからだった。
独自ドメイン設定はちゃんとある。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://www.namecheap.com/support/knowledgebase/article.aspx/9247/2208/how-do-i-use-my-domain-with-my-tumblr-account&#34;&gt;Namecheap.com Knowledgebase • How do I use my domain with my Tumblr account? (3rd Party Services Setup)&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;今回の構成はどうしようか悩んだんだけど、Tumblrの持つドメインに来たものはS3に飛ばすようにしてしまおうと思う。
というかそれ以外の方法が思いつかなかった。&lt;/p&gt;

&lt;p&gt;Tumblrに独自ドメインを設定すればおそらく304で転送してくれると思うので、それで飛ばしてしまいましょう。&lt;/p&gt;

&lt;h2 id=&#34;動作確認:a5812bfe3dbcf9a23add352ce7e9224f&#34;&gt;動作確認&lt;/h2&gt;

&lt;p&gt;以下のパターンで動作が確認できたのでとりあえずここまで。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;独自ドメインのルートパスアクセス（S3が表示される）&lt;/li&gt;
&lt;li&gt;独自ドメインの特定パスアクセス（Tumblrが表示される）&lt;/li&gt;
&lt;li&gt;Tumblrのドメインアクセス（独自ドメインのルートパスに転送されてS3が表示される）&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;オリジンによってキャッシュの設定も出来るしいい感じ。はてなとかでも出来そう。
問題点があるとすれば、aタグとかのURLがルートからのパス（&lt;code&gt;href=&amp;quot;/posts&amp;quot;&lt;/code&gt;）とかになっているテーマは使えないこと。
これは結構由々しき問題かも。でも実運用するときはテーマも作っちゃうだろうしいっか。&lt;/p&gt;

&lt;p&gt;でも全体的にバッドノウハウな感じあるし、自前でサーバ建てて振り分けるのが健全かな。&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>
